FROM ubuntu:16.04 

ENV KAFKA_USER=kafka
ENV KAFKA_DATA_DIR=/var/lib/kafka/data
ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
ENV KAFKA_HOME=/opt/kafka
ENV PATH=$PATH:/opt/kafka/bin

ARG KAFKA_VERSION=0.10.2.1
ARG KAFKA_DIST=kafka_2.11-0.10.2.1
RUN set -x \
    && apt-get update \
    && apt-get install -y openjdk-8-jre-headless wget \
    && wget -q "http://www.apache.org/dist/kafka/$KAFKA_VERSION/$KAFKA_DIST.tgz" \
    && wget -q "http://www.apache.org/dist/kafka/$KAFKA_VERSION/$KAFKA_DIST.tgz.asc" \
    && wget -q "http://kafka.apache.org/KEYS" \
    && export GNUPGHOME="$(mktemp -d)" \
    && gpg --import KEYS \
    && gpg --batch --verify "$KAFKA_DIST.tgz.asc" "$KAFKA_DIST.tgz" \
    && tar -xzf "$KAFKA_DIST.tgz" -C /opt \
    && rm -r "$GNUPGHOME" "$KAFKA_DIST.tgz" "$KAFKA_DIST.tgz.asc"
    
RUN set -x \
    && ln -s /opt/$KAFKA_DIST $KAFKA_HOME \
    && useradd $KAFKA_USER \
    && [ `id -u $KAFKA_USER` -eq 1000 ] \
    && [ `id -g $KAFKA_USER` -eq 1000 ] \
    && mkdir -p $KAFKA_DATA_DIR \
    && chown -R "$KAFKA_USER:$KAFKA_USER"  /opt/$KAFKA_DIST \
    && chown -R "$KAFKA_USER:$KAFKA_USER"  $KAFKA_DATA_DIR

EXPOSE 9093
VOLUME /data/kafka
COPY log4j.properties $KAFKA_HOME/config/

ENV DEBUG=true
ENV FILE_ENCODING=UTF-8
ENV LOGGING_LEVEL=INFO
ENV MEMORY_SIZE=medium
ENV KAFKA_HEAP_OPTS=""
ENV LOG_DIR=/data/kafka
ENV LISTENERS=PLAINTEXT://:9093
ENV AUTO_CREATE_TOPICS_ENABLE=true
ENV AUTO_LEADER_REBALANCE_ENABLE=true
ENV BACKGROUND_THREADS=10
ENV COMPRESSION_TYPE=producer
ENV DELETE_TOPIC_ENABLE=false
ENV LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS=300
ENV LEADER_IMBALANCE_PER_BROKER_PERCENTAGE=10
ENV LOG_FLUSH_INTERVAL_MESSAGES=9223372036854775807
ENV LOG_FLUSH_OFFSET_CHECKPOINT_INTERVAL_MS=60000
ENV LOG_FLUSH_SCHEDULER_INTERVAL_MS=9223372036854775807
ENV LOG_RETENTION_BYTES=-1
ENV LOG_RETENTION_HOURS=168
ENV LOG_ROLL_HOURS=168
ENV LOG_ROLL_JITTER_HOURS=0
ENV LOG_SEGMENT_BYTES=1073741824
ENV LOG_SEGMENT_DELETE_DELAY_MS=60000
ENV MESSAGE_MAX_BYTES=1000012
ENV MIN_INSYNC_REPLICAS=1
ENV NUM_IO_THREADS=8
ENV NUM_NETWORK_THREADS=3
ENV NUM_RECOVERY_THREADS_PER_DATA_DIR=1
ENV NUM_REPLICA_FETCHERS=1
ENV OFFSET_METADATA_MAX_BYTES=4096
ENV OFFSETS_COMMIT_REQUIRED_ACKS=-1
ENV OFFSETS_COMMIT_TIMEOUT_MS=5000
ENV OFFSETS_LOAD_BUFFER_SIZE=5242880
ENV OFFSETS_RETENTION_CHECK_INTERVAL_MS=600000
ENV OFFSETS_RETENTION_MINUTES=1440
ENV OFFSETS_TOPIC_COMPRESSION_CODEC=0
ENV OFFSETS_TOPIC_NUM_PARTITIONS=50
ENV OFFSETS_TOPIC_REPLICATION_FACTOR=3
ENV OFFSETS_TOPIC_SEGMENT_BYTES=104857600
ENV QUOTA_CONSUMER_DEFAULT=9223372036854775807
ENV QUOTA_PRODUCER_DEFAULT=9223372036854775807
ENV REPLICA_FETCH_MIN_BYTES=1
ENV REPLICA_FETCH_WAIT_MAX_MS=500
ENV REPLICA_HIGH_WATERMARK_CHECKPOINT_INTERVAL_MS=5000
ENV REPLICA_LAG_TIME_MAX_MS=10000
ENV REPLICA_SOCKET_RECEIVE_BUFFER_BYTES=65536
ENV REPLICA_SOCKET_TIMEOUT_MS=30000
ENV REQUEST_TIMEOUT_MS=30000
ENV SOCKET_RECEIVE_BUFFER_BYTES=102400
ENV SOCKET_REQUEST_MAX_BYTES=104857600
ENV SOCKET_SEND_BUFFER_BYTES=102400
ENV UNCLEAN_LEADER_ELECTION_ENABLE=true
ENV ZOOKEEPER_SESSION_TIMEOUT_MS=6000
ENV ZOOKEEPER_SET_ACL=false
ENV BROKER_ID_GENERATION_ENABLE=true
ENV CONNECTIONS_MAX_IDLE_MS=600000
ENV CONTROLLED_SHUTDOWN_ENABLE=true
ENV CONTROLLED_SHUTDOWN_MAX_RETRIES=3
ENV CONTROLLED_SHUTDOWN_RETRY_BACKOFF_MS=5000
ENV CONTROLLER_SOCKET_TIMEOUT_MS=30000
ENV DEFAULT_REPLICATION_FACTOR=1
ENV FETCH_PURGATORY_PURGE_INTERVAL_REQUESTS=1000
ENV GROUP_MAX_SESSION_TIMEOUT_MS=300000
ENV GROUP_MIN_SESSION_TIMEOUT_MS=6000
ENV INTER_BROKER_PROTOCOL_VERSION=0.10.2-IV0
ENV LOG_CLEANER_BACKOFF_MS=15000
ENV LOG_CLEANER_DEDUPE_BUFFER_SIZE=134217728
ENV LOG_CLEANER_DELETE_RETENTION_MS=86400000
ENV LOG_CLEANER_ENABLE=true
ENV LOG_CLEANER_IO_BUFFER_LOAD_FACTOR=0.9
ENV LOG_CLEANER_IO_BUFFER_SIZE=524288
ENV LOG_CLEANER_IO_MAX_BYTES_PER_SECOND=1.7976931348623157E308
ENV LOG_CLEANER_MIN_CLEANABLE_RATIO=0.5
ENV LOG_CLEANER_MIN_COMPACTION_LAG_MS=0
ENV LOG_CLEANER_THREADS=1
ENV LOG_CLEANUP_POLICY=delete
ENV LOG_INDEX_INTERVAL_BYTES=4096
ENV LOG_INDEX_SIZE_MAX_BYTES=10485760
ENV LOG_MESSAGE_TIMESTAMP_DIFFERENCE_MAX_MS=9223372036854775807
ENV LOG_MESSAGE_TIMESTAMP_TYPE=CreateTime
ENV LOG_PREALLOCATE=false
ENV LOG_RETENTION_CHECK_INTERVAL_MS=300000
ENV MAX_CONNECTIONS_PER_IP=2147483647
ENV NUM_PARTITIONS=1
ENV PRODUCER_PURGATORY_PURGE_INTERVAL_REQUESTS=1000
ENV REPLICA_FETCH_BACKOFF_MS=1000
ENV REPLICA_FETCH_MAX_BYTES=1048576
ENV REPLICA_FETCH_RESPONSE_MAX_BYTES=10485760
ENV RESERVED_BROKER_MAX_ID=1000

COPY bootstrap.sh net /usr/bin/

CMD bootstrap.sh
