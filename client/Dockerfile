FROM ubuntu:16.04

ENV KAFKA_USER=kafka
ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
ENV KAFKA_HOME=/opt/kafka
ENV PATH=$PATH:$KAFKA_HOME/bin

ARG KAFKA_VERSION=0.10.2.1
ARG KAFKA_DIST=kafka_2.11-0.10.2.1
RUN set -x \
    && apt-get update \
    && apt-get install -y openjdk-8-jre-headless wget \
    && wget -q "http://mirrors.shu.edu.cn/apache/kafka/$KAFKA_VERSION/$KAFKA_DIST.tgz" \
    && tar -xzf "$KAFKA_DIST.tgz" -C /opt \
    && rm -rf "$KAFKA_DIST.tgz"
    
RUN set -x \
    && ln -s /opt/$KAFKA_DIST $KAFKA_HOME \
    && useradd $KAFKA_USER \
    && [ `id -u $KAFKA_USER` -eq 1000 ] \
    && [ `id -g $KAFKA_USER` -eq 1000 ] \
    && chown -R "$KAFKA_USER:$KAFKA_USER"  /opt/$KAFKA_DIST

COPY log4j.properties $KAFKA_HOME/config/
COPY Shanghai /etc/localtime

ENV DEBUG=true
ENV FILE_ENCODING=UTF-8
ENV LOGGING_LEVEL=INFO
ENV MEMORY_SIZE=medium
ENV LOG_DIR=/data/kafka
ENV LISTENERS=PLAINTEXT://:9093
ENV AUTO_CREATE_TOPICS_ENABLE=true
ENV AUTO_LEADER_REBALANCE_ENABLE=true
ENV BACKGROUND_THREADS=10
ENV COMPRESSION_TYPE=producer
ENV DELETE_TOPIC_ENABLE=false
ENV LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS=300
ENV LEADER_IMBALANCE_PER_BROKER_PERCENTAGE=10
ENV LOG_FLUSH_INTERVAL_MESSAGES=9223372036854775807
ENV LOG_FLUSH_OFFSET_CHECKPOINT_INTERVAL_MS=60000
ENV LOG_FLUSH_SCHEDULER_INTERVAL_MS=9223372036854775807
ENV LOG_RETENTION_BYTES=-1
ENV LOG_RETENTION_HOURS=168
ENV LOG_ROLL_HOURS=168
ENV LOG_ROLL_JITTER_HOURS=0
ENV LOG_SEGMENT_BYTES=1073741824
ENV LOG_SEGMENT_DELETE_DELAY_MS=60000
ENV MESSAGE_MAX_BYTES=1000012
ENV MIN_INSYNC_REPLICAS=1
ENV NUM_IO_THREADS=8
ENV NUM_NETWORK_THREADS=3
ENV NUM_RECOVERY_THREADS_PER_DATA_DIR=1
ENV NUM_REPLICA_FETCHERS=1

COPY bootstrap.sh net /usr/bin/

CMD bootstrap.sh
